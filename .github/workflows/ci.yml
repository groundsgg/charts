name: üîç CI

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/ci.yml'

permissions:
  contents: read

env:
  HELM_VERSION: "3.19.0"

jobs:
  detect-changes:
    name: üîç Detect Changed Charts
    runs-on: ubuntu-latest
    outputs:
      common-changed: ${{ steps.detect.outputs.common-changed }}
      grounds-api-changed: ${{ steps.detect.outputs.grounds-api-changed }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üîç Detect changed charts
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            
            # Fetch the base branch to ensure we have the base SHA
            git fetch origin "$BASE_REF" --depth=1
            
            # Use the fetched base ref if base SHA is not available
            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
              BASE_SHA="origin/$BASE_REF"
            fi
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            
            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
              BASE_SHA="HEAD^"
            fi
          fi
          
          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "^charts/common/"; then
            echo "common-changed=true" >> $GITHUB_OUTPUT
          else
            echo "common-changed=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "^charts/grounds-api/"; then
            echo "grounds-api-changed=true" >> $GITHUB_OUTPUT
          else
            echo "grounds-api-changed=false" >> $GITHUB_OUTPUT
          fi

  lint:
    name: üîç Lint Charts
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: üîß Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: üîç Lint Common Chart
        if: needs.detect-changes.outputs.common-changed == 'true'
        run: |
          helm lint charts/common

      - name: üîç Lint grounds-api Chart
        if: needs.detect-changes.outputs.grounds-api-changed == 'true'
        run: |
          helm dependency update charts/grounds-api
          helm lint charts/grounds-api

  test:
    name: üß™ Test Charts
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: üîß Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: üîß Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: üîß Setup Kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.7.0/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: üß™ Test Common Chart
        if: needs.detect-changes.outputs.common-changed == 'true'
        run: |
          helm template test charts/common | kubeconform -summary -strict -skip IngressRoute,Middleware

      - name: üß™ Test grounds-api Chart
        if: needs.detect-changes.outputs.grounds-api-changed == 'true'
        run: |
          helm dependency update charts/grounds-api
          helm template test charts/grounds-api --set player.enabled=true --set server.enabled=true | kubeconform -summary -strict -skip IngressRoute,Middleware

      - name: üß™ Test grounds-api Chart (player only)
        if: needs.detect-changes.outputs.grounds-api-changed == 'true'
        run: |
          helm dependency update charts/grounds-api
          helm template test charts/grounds-api --set player.enabled=true --set server.enabled=false | kubeconform -summary -strict -skip IngressRoute,Middleware

      - name: üß™ Test grounds-api Chart (server only)
        if: needs.detect-changes.outputs.grounds-api-changed == 'true'
        run: |
          helm dependency update charts/grounds-api
          helm template test charts/grounds-api --set player.enabled=false --set server.enabled=true | kubeconform -summary -strict -skip IngressRoute,Middleware

  package:
    name: üì¶ Package Charts
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: üîß Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: üìÅ Create output directory
        run: mkdir -p .output

      - name: üì¶ Package Common Chart
        if: needs.detect-changes.outputs.common-changed == 'true'
        run: |
          helm package charts/common --destination .output

      - name: üì¶ Package grounds-api Chart
        if: needs.detect-changes.outputs.grounds-api-changed == 'true'
        run: |
          helm dependency update charts/grounds-api
          helm package charts/grounds-api --destination .output

      - name: üîç Verify packaged files
        run: |
          if ls .output/*.tgz 1> /dev/null 2>&1; then
            echo "‚úÖ Successfully packaged charts:"
            ls -lh .output/*.tgz
          else
            echo "‚ö†Ô∏è No charts were packaged (expected if no charts changed)"
          fi

