name: ğŸ” CI

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/ci.yml'

permissions:
  contents: read

env:
  HELM_VERSION: "3.19.0"

jobs:
  lint:
    name: ğŸ” Lint Charts
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ”§ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: ğŸ” Lint Common Chart
        run: |
          helm lint charts/common

      - name: ğŸ” Lint grounds-api Chart
        run: |
          helm dependency update charts/grounds-api
          helm lint charts/grounds-api

  test:
    name: ğŸ§ª Test Charts
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ”§ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: ğŸ”§ Setup Kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/download/v0.7.0/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: ğŸ§ª Test Common Chart
        run: |
          helm template test charts/common | kubeconform -summary -strict -skip IngressRoute -skip Middleware

      - name: ğŸ§ª Test grounds-api Chart
        run: |
          helm dependency update charts/grounds-api
          helm template test charts/grounds-api --set player.enabled=true --set server.enabled=true | kubeconform -summary -strict -skip IngressRoute -skip Middleware

      - name: ğŸ§ª Test grounds-api Chart (player only)
        run: |
          helm dependency update charts/grounds-api
          helm template test charts/grounds-api --set player.enabled=true --set server.enabled=false | kubeconform -summary -strict -skip IngressRoute -skip Middleware

      - name: ğŸ§ª Test grounds-api Chart (server only)
        run: |
          helm dependency update charts/grounds-api
          helm template test charts/grounds-api --set player.enabled=false --set server.enabled=true | kubeconform -summary -strict -skip IngressRoute -skip Middleware

